<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RULEV3+ Dashboard (Data-Driven)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Consolas', monospace; background: #0d1117; color: #c9d1d9; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        h1 { color: #58a6ff; font-size: 1.4rem; }
        .meta { color: #8b949e; font-size: 0.8rem; margin-top: 8px; }
        .meta code { background: #21262d; padding: 2px 6px; border-radius: 4px; color: #7ee787; }

        .source { background: #0d1117; border: 1px solid #238636; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
        .source h3 { color: #3fb950; font-size: 0.85rem; margin-bottom: 10px; }
        .source pre { background: #161b22; padding: 12px; border-radius: 4px; font-size: 0.75rem; overflow-x: auto; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; }
        .card.live { border-left: 3px solid #3fb950; }
        .card.bt { border-left: 3px solid #58a6ff; }
        .card h3 { color: #8b949e; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .stat { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #21262d; }
        .stat:last-child { border-bottom: none; }
        .label { color: #8b949e; }
        .value { font-weight: bold; }
        .positive { color: #3fb950; }
        .negative { color: #f85149; }

        .chart-box { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .chart-box h3 { color: #58a6ff; font-size: 0.95rem; margin-bottom: 4px; }
        .chart-box .derivation { color: #8b949e; font-size: 0.7rem; margin-bottom: 16px; }
        .chart-wrapper { height: 280px; }

        .audit { background: #161b22; border: 1px solid #d29922; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .audit h3 { color: #d29922; font-size: 0.95rem; margin-bottom: 16px; }
        .audit table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .audit th, .audit td { padding: 8px; text-align: left; border-bottom: 1px solid #21262d; }
        .audit th { color: #8b949e; }
        .audit tr:hover { background: #21262d; }

        .footer { text-align: center; color: #8b949e; font-size: 0.7rem; padding-top: 20px; border-top: 1px solid #30363d; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>RULEV3+ Validation Dashboard</h1>
        <div class="meta">
            Data: <code>docs/trades.csv</code> |
            Live: <code>32</code> trades |
            Backtest: <code>1008</code> trades |
            Generated: <code>2025-12-25 14:28:19</code>
        </div>
    </div>

    <div class="source">
        <h3>DATA LINEAGE</h3>
        <pre>
SOURCE FILES:
  logs/paper/trades_20251224_194001.log  ->  live_current dataset
  backtest_full_logs/.../trades_full.jsonl  ->  bt_current dataset

PIPELINE:
  1. parse_live_trades()   -> extract (timestamp, pnl, edge, ask, direction)
  2. parse_backtest_trades() -> extract (elapsed_seconds, pnl, outcome)
  3. export_trades_csv()   -> docs/trades.csv (single source of truth)
  4. compute_metrics()     -> equity=cumsum(pnl), timing=groupby(5s), heatmap=groupby(1s)
  5. generate_html()       -> inject computed arrays into chart config

DERIVATION FORMULAS:
  seconds_into_session = (entry_ts - session_start_ts).total_seconds()
  equity[i] = sum(pnl[0:i+1])
  timing_bin = floor(seconds_into_session / 5) * 5
  heatmap_second = int(seconds_into_session)
        </pre>
    </div>

    <div class="grid">
        <div class="card live">
            <h3>Live Paper Trading</h3>
            <div class="stat"><span class="label">Trades</span><span class="value">32</span></div>
            <div class="stat"><span class="label">Wins</span><span class="value">25</span></div>
            <div class="stat"><span class="label">Win Rate</span><span class="value">78.12%</span></div>
            <div class="stat"><span class="label">Total PnL</span><span class="value positive">$24.0</span></div>
            <div class="stat"><span class="label">Avg PnL</span><span class="value positive">$0.75</span></div>
        </div>
        <div class="card bt">
            <h3>Backtest CORE</h3>
            <div class="stat"><span class="label">Trades</span><span class="value">1008</span></div>
            <div class="stat"><span class="label">Wins</span><span class="value">720</span></div>
            <div class="stat"><span class="label">Win Rate</span><span class="value">71.43%</span></div>
            <div class="stat"><span class="label">Total PnL</span><span class="value positive">$40.24</span></div>
            <div class="stat"><span class="label">Avg PnL</span><span class="value positive">$0.0399</span></div>
        </div>
    </div>

    <div class="chart-box">
        <h3>Equity Curve</h3>
        <div class="derivation">equity[i] = cumsum(pnl[0:i+1]) | No scaling, no normalization</div>
        <div class="chart-wrapper"><canvas id="equityChart"></canvas></div>
    </div>

    <div class="chart-box">
        <h3>Entry Timing Distribution</h3>
        <div class="derivation">bin = floor(seconds_into_session / 5) * 5 | count per bin | CORE: 180-209s shaded</div>
        <div class="chart-wrapper"><canvas id="timingChart"></canvas></div>
    </div>

    <div class="chart-box">
        <h3>CORE Window Heatmap (1s resolution)</h3>
        <div class="derivation">count per integer second in range [180, 209]</div>
        <div class="chart-wrapper"><canvas id="heatmapChart"></canvas></div>
    </div>

    <div class="audit">
        <h3>AUDIT TRAIL: Every Trade Traceable</h3>
        <table>
            <tr>
                <th>#</th>
                <th>Entry Timestamp</th>
                <th>Elapsed (s)</th>
                <th>Timing Bin</th>
                <th>Heatmap Sec</th>
                <th>In CORE?</th>
                <th>Outcome</th>
                <th>PnL</th>
            </tr>
            <tr>
            <td>1</td>
            <td>2025-12-24T19:48:14</td>
            <td>194</td>
            <td>190s</td>
            <td>194s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.69</td>
        </tr><tr>
            <td>2</td>
            <td>2025-12-24T20:18:01</td>
            <td>181</td>
            <td>180s</td>
            <td>181s</td>
            <td>Yes</td>
            <td>LOSS</td>
            <td class="negative">$-5.0</td>
        </tr><tr>
            <td>3</td>
            <td>2025-12-24T20:48:02</td>
            <td>182</td>
            <td>180s</td>
            <td>182s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.46</td>
        </tr><tr>
            <td>4</td>
            <td>2025-12-24T21:18:03</td>
            <td>183</td>
            <td>180s</td>
            <td>183s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.58</td>
        </tr><tr>
            <td>5</td>
            <td>2025-12-24T21:33:16</td>
            <td>196</td>
            <td>195s</td>
            <td>196s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.35</td>
        </tr><tr>
            <td>6</td>
            <td>2025-12-24T22:33:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>LOSS</td>
            <td class="negative">$-5.0</td>
        </tr><tr>
            <td>7</td>
            <td>2025-12-25T00:03:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.04</td>
        </tr><tr>
            <td>8</td>
            <td>2025-12-25T00:18:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.35</td>
        </tr><tr>
            <td>9</td>
            <td>2025-12-25T02:03:17</td>
            <td>197</td>
            <td>195s</td>
            <td>197s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.69</td>
        </tr><tr>
            <td>10</td>
            <td>2025-12-25T02:18:03</td>
            <td>183</td>
            <td>180s</td>
            <td>183s</td>
            <td>Yes</td>
            <td>LOSS</td>
            <td class="negative">$-5.0</td>
        </tr><tr>
            <td>11</td>
            <td>2025-12-25T03:33:22</td>
            <td>202</td>
            <td>200s</td>
            <td>202s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.69</td>
        </tr><tr>
            <td>12</td>
            <td>2025-12-25T03:48:03</td>
            <td>183</td>
            <td>180s</td>
            <td>183s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.04</td>
        </tr><tr>
            <td>13</td>
            <td>2025-12-25T04:18:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.25</td>
        </tr><tr>
            <td>14</td>
            <td>2025-12-25T04:33:01</td>
            <td>181</td>
            <td>180s</td>
            <td>181s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.69</td>
        </tr><tr>
            <td>15</td>
            <td>2025-12-25T05:18:28</td>
            <td>208</td>
            <td>205s</td>
            <td>208s</td>
            <td>Yes</td>
            <td>LOSS</td>
            <td class="negative">$-5.0</td>
        </tr><tr>
            <td>16</td>
            <td>2025-12-25T05:33:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.04</td>
        </tr><tr>
            <td>17</td>
            <td>2025-12-25T06:03:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.35</td>
        </tr><tr>
            <td>18</td>
            <td>2025-12-25T07:03:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>LOSS</td>
            <td class="negative">$-5.0</td>
        </tr><tr>
            <td>19</td>
            <td>2025-12-25T07:33:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.58</td>
        </tr><tr>
            <td>20</td>
            <td>2025-12-25T07:48:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.25</td>
        </tr><tr>
            <td>21</td>
            <td>2025-12-25T08:03:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.14</td>
        </tr><tr>
            <td>22</td>
            <td>2025-12-25T08:18:06</td>
            <td>186</td>
            <td>185s</td>
            <td>186s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.04</td>
        </tr><tr>
            <td>23</td>
            <td>2025-12-25T08:33:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.14</td>
        </tr><tr>
            <td>24</td>
            <td>2025-12-25T09:33:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.04</td>
        </tr><tr>
            <td>25</td>
            <td>2025-12-25T09:48:14</td>
            <td>194</td>
            <td>190s</td>
            <td>194s</td>
            <td>Yes</td>
            <td>LOSS</td>
            <td class="negative">$-5.0</td>
        </tr><tr>
            <td>26</td>
            <td>2025-12-25T10:03:02</td>
            <td>182</td>
            <td>180s</td>
            <td>182s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.58</td>
        </tr><tr>
            <td>27</td>
            <td>2025-12-25T10:33:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.25</td>
        </tr><tr>
            <td>28</td>
            <td>2025-12-25T10:48:13</td>
            <td>193</td>
            <td>190s</td>
            <td>193s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.69</td>
        </tr><tr>
            <td>29</td>
            <td>2025-12-25T12:18:02</td>
            <td>182</td>
            <td>180s</td>
            <td>182s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.14</td>
        </tr><tr>
            <td>30</td>
            <td>2025-12-25T12:48:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.58</td>
        </tr><tr>
            <td>31</td>
            <td>2025-12-25T13:03:01</td>
            <td>181</td>
            <td>180s</td>
            <td>181s</td>
            <td>Yes</td>
            <td>LOSS</td>
            <td class="negative">$-5.0</td>
        </tr><tr>
            <td>32</td>
            <td>2025-12-25T14:03:00</td>
            <td>180</td>
            <td>180s</td>
            <td>180s</td>
            <td>Yes</td>
            <td>WIN</td>
            <td class="positive">$2.35</td>
        </tr>
        </table>
    </div>

    <div class="footer">
        Re-run: <code>python build_dashboard_pipeline.py</code> | Add trades to CSV and re-run to update
    </div>
</div>

<script>
    // DATA_FROM_PYTHON - All arrays computed from trades.csv via Python
    // No hardcoded values - regenerate by running build_dashboard_pipeline.py

    const LIVE_EQUITY = [2.69, -2.31, 0.15, 2.73, 5.08, 0.08, 2.12, 4.47, 7.16, 2.16, 4.85, 6.89, 9.14, 11.83, 6.83, 8.87, 11.22, 6.22, 8.8, 11.05, 13.19, 15.23, 17.37, 19.41, 14.41, 16.99, 19.24, 21.93, 24.07, 26.65, 21.65, 24.0];
    const BT_EQUITY = [-0.65, -0.32, -0.97, -0.62, -0.27, -0.92, -0.63, -1.28, -1.93, -1.58, -2.25, -1.96, -2.63, -3.3, -2.97, -2.63, -2.28, -1.99, -2.69, -2.34, -3.05, -3.75, -3.42, -3.07, -3.73, -3.4, -3.07, -2.78, -2.45, -2.1, -1.79, -1.46];
    const TIMING_LABELS = ['180s', '185s', '190s', '195s', '200s', '205s'];
    const LIVE_TIMING = [24, 1, 3, 2, 1, 1];
    const BT_TIMING = [650, 112, 85, 64, 55, 42];
    const HEATMAP_LABELS = ['3:00', '3:01', '3:02', '3:03', '3:04', '3:05', '3:06', '3:07', '3:08', '3:09', '3:10', '3:11', '3:12', '3:13', '3:14', '3:15', '3:16', '3:17', '3:18', '3:19', '3:20', '3:21', '3:22', '3:23', '3:24', '3:25', '3:26', '3:27', '3:28', '3:29'];
    const LIVE_HEATMAP = [15, 3, 3, 3, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 2, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0];
    const BT_HEATMAP = [501, 43, 42, 33, 31, 26, 24, 26, 18, 18, 22, 19, 20, 15, 9, 15, 17, 10, 13, 9, 11, 10, 11, 11, 12, 11, 12, 9, 10, 0];

    const CORE_START_BIN = 180;
    const CORE_END_BIN = 209;

    const colors = { live: '#3fb950', bt: '#58a6ff', grid: '#21262d', text: '#8b949e' };

    // Equity Chart
    new Chart(document.getElementById('equityChart'), {
        type: 'line',
        data: {
            labels: Array.from({length: LIVE_EQUITY.length}, (_, i) => i + 1),
            datasets: [
                { label: 'Live cumsum(pnl)', data: LIVE_EQUITY, borderColor: colors.live, backgroundColor: 'rgba(63,185,80,0.1)', fill: true, tension: 0.2, pointRadius: 3 },
                { label: 'Backtest cumsum(pnl)', data: BT_EQUITY, borderColor: colors.bt, backgroundColor: 'rgba(88,166,255,0.05)', fill: true, tension: 0.2, pointRadius: 2, borderDash: [4,4] }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: colors.text } } },
            scales: {
                x: { title: { display: true, text: 'Trade #', color: colors.text }, grid: { color: colors.grid }, ticks: { color: colors.text } },
                y: { title: { display: true, text: 'Cumulative PnL ($)', color: colors.text }, grid: { color: colors.grid }, ticks: { color: colors.text } }
            }
        }
    });

    // Timing Chart with CORE zone annotation
    new Chart(document.getElementById('timingChart'), {
        type: 'bar',
        data: {
            labels: TIMING_LABELS,
            datasets: [
                { label: 'Live', data: LIVE_TIMING, backgroundColor: 'rgba(63,185,80,0.8)', borderColor: colors.live, borderWidth: 1 },
                { label: 'Backtest (/20)', data: BT_TIMING.map(v => v/20), backgroundColor: 'rgba(88,166,255,0.6)', borderColor: colors.bt, borderWidth: 1 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: colors.text } },
                annotation: {
                    annotations: {
                        coreZone: {
                            type: 'box',
                            xMin: TIMING_LABELS.indexOf('180s') - 0.5,
                            xMax: TIMING_LABELS.indexOf('205s') + 0.5,
                            backgroundColor: 'rgba(63,185,80,0.1)',
                            borderColor: 'rgba(63,185,80,0.5)',
                            borderWidth: 1,
                            label: { content: 'CORE', display: true, position: 'start' }
                        }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Elapsed Seconds (5s bins)', color: colors.text }, grid: { display: false }, ticks: { color: colors.text } },
                y: { title: { display: true, text: 'Trade Count', color: colors.text }, grid: { color: colors.grid }, ticks: { color: colors.text } }
            }
        }
    });

    // Heatmap Chart
    new Chart(document.getElementById('heatmapChart'), {
        type: 'bar',
        data: {
            labels: HEATMAP_LABELS,
            datasets: [
                { label: 'Live', data: LIVE_HEATMAP, backgroundColor: 'rgba(63,185,80,0.8)' },
                { label: 'Backtest (/5)', data: BT_HEATMAP.map(v => v/5), backgroundColor: 'rgba(88,166,255,0.6)' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: colors.text } } },
            scales: {
                x: { title: { display: true, text: 'Second (3:XX)', color: colors.text }, grid: { display: false }, ticks: { color: colors.text, maxRotation: 45 } },
                y: { title: { display: true, text: 'Trade Count', color: colors.text }, grid: { color: colors.grid }, ticks: { color: colors.text } }
            }
        }
    });
</script>
</body>
</html>